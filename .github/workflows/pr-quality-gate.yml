# PR quality gate â€” auto-labels shallow PRs for maintainer review
name: PR Quality Gate

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write
  issues: write

jobs:
  check-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR quality
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;

            const issues = [];

            // Check for linked issue
            const hasIssueRef = /(?:fixes|closes|resolves)\s*#\d+/i.test(body) ||
                                /#\d+/.test(body);
            if (!hasIssueRef) {
              issues.push('- No linked issue found. PRs should reference an issue (`Fixes #123`).');
            }

            // Check for empty or template-only body
            const strippedBody = body
              .replace(/<!--[\s\S]*?-->/g, '')
              .replace(/#+\s*.*/g, '')
              .replace(/- \[ \].*/g, '')
              .replace(/\s/g, '');
            if (strippedBody.length < 30) {
              issues.push('- PR description is too short. Please describe what this PR does.');
            }

            if (issues.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['needs-work']
              });

              const message = `Thanks for the PR! A couple things to address:\n\n${issues.join('\n')}\n\nSee the [PR template](../blob/main/.github/PULL_REQUEST_TEMPLATE.md) for guidance.`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message
              });
            }
